{% extends 'base.html' %}

{% block title %}
Mystify - Play Multiplayer
{% endblock %}

{% block content %}
    <style>
        .message {
            max-width: 80%;
            margin-block: 8px;
            padding: 12px;
            border-radius: 10px;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.3s ease forwards;
        }
        .message {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            margin-right: auto;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .clue-card {
            background: url('{{ url_for('static', filename='img/assets/clue.png') }}') no-repeat center;
            background-size: contain;
            aspect-ratio: 1;
            width: 200px;
            position: relative;
            margin: 10px;
        }

        .clue-gems {
            background: url('{{ url_for('static', filename='img/assets/gems clue.png') }}') no-repeat center;
            background-size: contain;
            width: 200px;
            position: relative;
            margin: 10px;
        }

        .parchment-texture {
            background: url('{{ url_for('static', filename='img/assets/chat bg.png') }}') no-repeat center;
            background-size: cover;
        }

        @media (max-width: 768px) {
            .clue-card {
                width: 150px;
            }
        }
    </style>

    <div class="container mx-auto p-4">
        <!-- Main Content -->
        <div class="flex flex-col min-h-[80vh]">
            <div class="parchment-texture flex items-center justify-center mt-16">
                <div class="max-w-2xl w-full flex-grow mb-4 rounded-lg p-4 min-h-[400px] relative">
                    <div id="messages" class="max-h-[50vh] overflow-y-auto mx-auto flex flex-col mb-24 overflow-x-hidden">
                        {% for msg in room.messages %}
                            {% if msg.user and msg.content %}
                                <div class="message {% if msg.user.username == current_user.username %}sent{% else %}received{% endif %}">
                                    <strong>{{ msg.user.username }}</strong>: {{ msg.content }}
                                </div>
                            {% else %}
                                <div class="message received">
                                    <strong>Unknown</strong>: Message not available
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="bg-[#8b7355]/80 rounded-lg p-3 flex items-center gap-2 mt-auto mx-auto max-w-2xl absolute bottom-4 w-full left-1/2 -translate-x-1/2">
                        <input id="message-input" type="text" placeholder="Enter your message" class="w-full bg-transparent text-white placeholder-gray-300 focus:outline-none">
                        <button id="send-message" class="p-2">
                            <ion-icon name="send-outline" class="text-white text-2xl"></ion-icon>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Clues Grid -->
            <div class="flex flex-wrap w-full items-center justify-center">
                <div class="clue-card clue-free cursor-pointer"></div>
                <div class="clue-card clue-free cursor-pointer"></div>
                <div class="clue-card clue-free cursor-pointer"></div>
                <div class="clue-card clue-gems cursor-pointer"></div>
                <div class="clue-card clue-gems cursor-pointer"></div>
            </div>
        </div>
    </div>
    <div class="input-container">
        <div class="flex gap-4 items-center">
            <input 
                type="text" 
                placeholder="Enter Correct Answer" 
                class="flex-grow bg-[#8b7355]/80 text-white placeholder-gray-300 p-3 rounded-lg focus:outline-none"
            >
            <button class="bg-[#cd7f32] text-white px-6 py-3 rounded-lg">
                Label
            </button>
        </div>
    </div>

    <script>
        const socket = io();
        const roomCode = '{{ room.room_code }}'; // Get the room code from the server

        // Join the room
        socket.emit('join', { room: roomCode });

        // Handle incoming messages
        socket.on('message', function (data) {

            if (data.user)  {
            $('#messages').append(`<div><strong>${data.user}</strong>: ${data.message}</div>`);
            // Auto-scroll to the latest message
            const messageDiv = document.getElementById('messages');
            messageDiv.scrollTop = messageDiv.scrollHeight;
            }
        });

        // Send a message
        $('#send-message').on('click', function () {
            const message = $('#message-input').val();
            if (message) {
                socket.emit('message', { room: roomCode, message: message });
                $('#message-input').val(''); // Clear the input
            }
        });

        // Submit message when pressing "Enter"
        $('#message-input').on('keypress', function (e) {
            if (e.which == 13) {
                $('#send-message').click();
            }
        });

        // Auto-scroll to the bottom of the messages on load to show the latest messages
        window.onload = function() {
            const messageDiv = document.getElementById('messages');
            messageDiv.scrollTop = messageDiv.scrollHeight;
        };

        const caseId = '{{ room.case_id }}';  // Assuming you have access to case ID in the room context

    // Function to send AJAX request and update the clue card
    function fetchClue(clueNo) {
        $.ajax({
            type: 'POST',
            url: '/get-clue',
            data: {
                case_id: caseId,
                clue_no: clueNo
            },
            success: function(response) {
                // Update the clue card content with the received clue
                console.log(response.clue)
            },
            error: function(jqXHR, textStatus, errorThrown) {
                response = jqXHR.responseJSON
                showFlashMessage(response.error)
            }
        });
    }

    // Adding event listeners for each clue card
    $(document).ready(function() {
        $('.clue-free').each(function(index) {
            const clueNo = index + 1;  // Clue numbers start from 1
            $(this).on('click', function() {
                fetchClue(clueNo);  // Call the function to fetch the clue for this card
            });
        });

        $('.clue-gems').each(function(index) {
            const clueNo = index + 4;  // Clue numbers for gems start from 4
            $(this).on('click', function() {
                fetchClue(clueNo);  // Call the function to fetch the clue for this card
            });
        });
    });
    </script>
{% endblock %}
